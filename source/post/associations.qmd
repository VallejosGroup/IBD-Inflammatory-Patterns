---
title: "Associations with cluster membership"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
  - name: "Catalina A. Vallejos"
    url: https://scholar.google.com/citations?user=lkdrwm0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: HGU
---

## Introduction

```{R Setup}
#| message: false
set.seed(123)
if (file.exists("/.dockerenv")) { # Check if running in Docker
  # Assume igmm/cvallejo-predicct/libdr/ is passed to the data volume
  prefix <- "data/"
} else {
  # Assume running outside of a Docker container and the IGC(/IGMM) datastore is
  # mounted at /Volumes
  prefix <- "/Volumes/igmm/cvallejo-predicct/libdr/"
}

##########################
#--     Packages       --#
##########################

library(tidyverse)
library(dplyr)
# Support package (source found in libdr/)
library(libdr)
## Modelling ##
library(lcmm)
library(nnet) # Multinomial logistic regression
## Survival analysis
library(survival)
library(survminer)
## Presentation ##
library(patchwork)
library(ggdist)
library(ggalluvial)
library(pander)
library(qqplotr)
library(table1)

library(ggmosaic)


dict <- readRDS(paste0(prefix, "processed/dict.RDS"))
fcal <- readRDS(paste0(prefix, "processed/fcal.RDS"))
model.fc <- readRDS(paste0(prefix, "/cache/fcal/ncs/fcal-10.RDS"))
crp <- readRDS(paste0(prefix, "processed/crp.RDS"))
crp.median <- readRDS(paste0(prefix, "processed/median-crp.RDS"))
model.crp <- readRDS(paste0(prefix, "cache/crp-ma/crp-9.RDS"))
```

This page explores potential associations between information available at
diagnosis, or shortly thereafter, and cluster membership. A descriptive analysis
of baseline variables in described in a
[previous page](../pre/baseline.qmd).

For univariate analyses, continuous data have been analysed via ANOVA, and
categorical data have been analysed using chi-squared or Fisher's exact test as
appropriate. Time-to-event data have been analysed using log-rank tests of 
Kaplan-Meier curves.

Multivariate analyses were also performed to potentially adjust for
confounding factors. 

As faecal calprotectin (FC) and C-reactive protein (CRP) were analysed
independently, this page is split into FC and CRP sections. 

## Faecal calprotectin analysis

### Merge subject-level metadata with model-derived quantities

Here, we create a `data.frame` that combines individual-level information
(e.g. age at diagnosis, sex) with model-derived quantities, such as the
posterior probabilities of class assignment. To facilitate visualisation, 
we also create discretised versions for some variables. 

```{r}
myDF.fc <- fcal %>%
  group_by(ids) %>%
  summarise(n.total = n(),
            followup = max(calpro_time),) %>%
  mutate(followup_cut = cut(followup, breaks = c(seq(0, 6, by = 2), 7)),
         n.total_cut = cut(n.total, breaks = c(0, 5, 10, 20, max(n.total))))
  
myDF.fc <- merge(myDF.fc, model.fc$pprob, by = "ids", all.x = FALSE, all.y = TRUE)
myDF.fc <- myDF.fc %>% 
  mutate(probmax = pmax(prob1, prob2, prob3, prob4, prob5, 
                        prob6, prob7, prob8, prob9, prob10))
myDF.fc <- merge(myDF.fc, dict, by = "ids", all.x = TRUE, all.y = FALSE)
```

### Posterior cluster assignment probabilities 

```{R}
#| label: fig-fc-prob-fup
#| fig-cap: "Demonstration of how mean posterior probabilities of cluster assignment for subjects changes based upon follow-up and assigned cluster."
#| column: body-outset
#| fig-width: 11
#| fig-height: 8

myDF.fc_means <- myDF.fc %>% 
  group_by(class, followup_cut) %>%
  summarise(across(starts_with("prob"), function(x) mean(x, na.rm = TRUE)),
            .groups = "drop") %>%
  pivot_longer(cols = starts_with("prob"), names_to = "prob")

# Assign level order otherwise alphanumerical order used
myDF.fc_means$prob <- factor(myDF.fc_means$prob,
                          levels = c(paste0("prob", 1:10), "probmax"),
                          labels = c(paste0("FC", 1:10), "probmax"))

myDF.fc_means$class <- factor(myDF.fc_means$class,
                           levels = 1:10,
                           labels = paste0("Assigned to FC", 1:10, "\n n = ",
                                           as.vector(table(myDF.fc$class))))


col.vec <- c("#df5c7f",
"#74c74a",
"#d159d3",
"#c2ae42",
"#8581da",
"#de6d3c",
"#74b0c3",
"#bc9d7a",
"#6cb886",
"#c597bd")


p <- myDF.fc_means %>%
  filter(prob != "probmax") %>%
  ggplot(aes(fill = prob, y = value, x = followup_cut)) +
  geom_bar(position = "fill", stat = "identity") +
  facet_wrap(.~class, ncol = 5) + 
  theme_minimal() +
  theme(legend.title = element_text(hjust = 0.5),
        strip.background = element_rect(color = "lightgray",
                                         linewidth = 1.5,
                                         linetype="solid")) +
  labs(x = "Follow-up cutoff (years)",
       y = "",
       fill = "Mean posterior\nprobability of\ncluster assignment") +
  scale_fill_manual(values = col.vec) 

ggsave("plots/fc-prob-fup.png", p, width = 11, height = 8, units = "in")
ggsave("plots/fc-prob-fup.pdf", p, width = 11, height = 8, units = "in")
p
```

@fig-fc-prob-fup shows how cluster assignment probabilities change as follow-up
for subjects increases. As one would expect, probabilities typically increase as
as follow-up increases. This relationship appears to depend upon when the mean
trajectory for the assigned cluster substantially differs from the other
clusters. FC8 shows high posterior probabilities with even short follow-up as
this is the only cluster with low FC at diagnosis. However, longer follow-ups 
are required to distinguish other clusters. For example, individuals
assigned to FC1 that have a short follow-up (< 2 years from diagnosis) only have
a marginally higher average probability of being assigned to FC1 than to FC6
(`r round(myDF.fc_means$value[myDF.fc_means$class == "Assigned to FC1" & myDF.fc_means$followup_cut == "(0,2]" & myDF.fc_means$prob == "FC1"], 3)`
versus
`r round(myDF.fc_means$value[myDF.fc_means$class == "Assigned to FC1" & myDF.fc_means$followup_cut == "(0,2]" & myDF.fc_means$prob == "FC6"], 3)`).
This is not unexpected, as FC1 and FC6 share similar patterns within the first
2 years.  

### Associations with respect to cluster assignments

This section displays descriptive plots to summarize marginal associations
between cluster assignments and individual-level covariates. Due to their small
size, we combine the three clusters with oscillatory FC patterns into one for
the purpose of this analysis. We also explore univariate and multivariate 
associations with respect to cluster assignment using multinomial logistic 
regression. As a sensitivity analysis, we also consider restricting the analysis 
to only consider individuals whose class assignment was less uncertain 
(with posterior probability > 0.5).

The following code is used to combine the three oscillatory FC clusters. 

```{r combine class}
myDF.fc <- myDF.fc %>% 
  mutate(class_combined = ifelse(class %in% c(2, 3, 9), 
                                 "FC2-3-9",
                                 paste0("FC", class)),
         prob239 = prob2 + prob3 + prob9,
         probmax_combined =  pmax(prob1, prob4, prob5, 
                                  prob6, prob7, prob8, prob10, prob239))

# Calculate sample size per group
group.size <- as.vector(table(myDF.fc$class))
group.size <- c(group.size[1], sum(group.size[c(2, 3, 9)]), group.size[4:8], group.size[10])

# Sort by sensible order rather than alphanumerical order
myDF.fc$class_combined <- factor(myDF.fc$class_combined,
                                      levels = c("FC1", "FC2-3-9", "FC4", "FC5",
                                            "FC6", "FC7", "FC8", "FC10"))
myDF.fc$class_combined_size <- factor(myDF.fc$class_combined,
                                      levels = c("FC1", "FC2-3-9", "FC4", "FC5",
                                            "FC6", "FC7", "FC8", "FC10"),
                                      labels = paste0(c("FC1", "FC2-3-9", "FC4", "FC5", 
                                                        "FC6", "FC7", "FC8", "FC10"),
                                                        " (n = ", group.size, ")"))
```

<!--- CAV: add here a table with summary statistics per cluster ---> 

#### For all individuals

<!--- IBD type has been included in the cluster assignment sub model as a covariate
and will therefore be analysed differently to the other variables considered.
Instead of chi-squared tests, Wald tests of the model covariates were conducted.
In these tests, Crohn's disease is the reference IBD type with cluster FC 8
being the reference cluster. 

The results of these tests are presented as both forest plots ([@fig-fc-ibd])
and a summary table ([@tbl-fc-ibd]).

Only ulcerative colitis in cluster 1 was found to be statistically significant. 
--->

Here, we consider associations with respect to information available at 
diagnosis: age, sex, IBD type and baseline FC. 

```{r}
p_diagnosis <- myDF.fc %>%
  plotCat("diagnosis") 

p_sex <- myDF.fc %>%
  plotCat("sex")

p_age <- myDF.fc %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  geom_boxplot(width=0.1, color="black", alpha=0.2) +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p_baseline_fc <- myDF.fc %>%
  ggplot(aes(x = class_combined, y = baseline_fc)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("FC at diagnosis")

p_mlr <- myDF.fc %>%
  mutate(class_combined = relevel(class_combined, ref = "FC4")) %>%
  mlrPlot(var = c("diagnosis", "age", "sex", "baseline_fc"), class = "class_combined")

#diagnosis
wrap_elements(p_diagnosis) + 
  p_mlr$plot$`diagnosisUlcerative Colitis` + p_mlr$plot$`diagnosisIBDU` +
  patchwork::plot_annotation(tag_levels = "A")

#age + sex + baseline_fc 
(wrap_elements(p_age) + p_mlr$plot$age) /
  (wrap_elements(p_sex) + p_mlr$plot$sexMale) /
  (wrap_elements(p_baseline_fc) + p_mlr$plot$baseline_fc) +
  patchwork::plot_annotation(tag_levels = "A")
```

Restricted to those with posterior probability > 0.5

```{r}
p_diagnosis <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  plotCat("diagnosis") 

p_sex <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  plotCat("sex")

p_age <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  geom_boxplot(width=0.1, color="black", alpha=0.2) +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p_baseline_fc <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  ggplot(aes(x = class_combined, y = baseline_fc)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("FC at diagnosis")

p_mlr <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  mutate(class_combined = relevel(class_combined, ref = "FC4")) %>%
  mlrPlot(var = c("diagnosis", "age", "sex", "baseline_fc"), class = "class_combined")

#diagnosis
wrap_elements(p_diagnosis) + 
  p_mlr$plot$`diagnosisUlcerative Colitis` + p_mlr$plot$`diagnosisIBDU` +
  patchwork::plot_annotation(tag_levels = "A")

#age + sex + baseline_fc 
(wrap_elements(p_age) + p_mlr$plot$age) /
  (wrap_elements(p_sex) + p_mlr$plot$sexMale) /
  (wrap_elements(p_baseline_fc) + p_mlr$plot$baseline_fc) +
  patchwork::plot_annotation(tag_levels = "A")
```


#### Crohn's disease only

```{r}
p_sex <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  plotCat("sex")

p_age <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  geom_boxplot(width=0.1, color="black", alpha=0.2) +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p_baseline_fc <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  ggplot(aes(x = class_combined, y = baseline_fc)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("FC at diagnosis")

p_smoke <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(Smoke = ifelse(!is.na(Smoke), Smoke, "Missing")) %>%
  plotCat("Smoke")

p_location <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(Location = ifelse(!is.na(Location), Location, "Missing")) %>%
  plotCat("Location")

p_L4 <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(L4 = ifelse(!is.na(L4), L4, "Missing")) %>%
  plotCat("L4")

p_behaviour <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(Behaviour = ifelse(!is.na(Behaviour), Behaviour, "Missing")) %>%
  plotCat("Behaviour")

p_perianal <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(Perianal = ifelse(!is.na(Perianal), Perianal, "Missing")) %>%
  plotCat("Perianal")

p_behaviour_p <- myDF.fc %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mutate(Behaviour = ifelse(!is.na(Behaviour), Behaviour, "Missing")) %>%
  mutate(Perianal = ifelse(!is.na(Perianal), Perianal, "Missing")) %>%
  mutate(BehaviourP = as.factor(paste0(Behaviour, "-", Perianal))) %>%
  plotCat("BehaviourP")

p_sex + plot_annotation(title = "Sex (CD patients only)")
p_age + plot_annotation(title = "Age (CD patients only)")
p_smoke + plot_annotation(title = "Smoking (CD patients only)")
p_location + plot_annotation(title = "Location (CD patients only)")
p_L4 + plot_annotation(title = "L4 (CD patients only)")
p_behaviour + plot_annotation(title = "Behaviour (CD patients only)")
p_perianal + plot_annotation(title = "Perianal (CD patients only)")
```

#### Ulcerative Colitis only

```{r}
p_sex <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  plotCat("sex")

p_age <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  geom_boxplot(width=0.1, color="black", alpha=0.2) +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p_baseline_fc <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  ggplot(aes(x = class_combined, y = baseline_fc)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("FC at diagnosis")

p_smoke <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mutate(Smoke = ifelse(!is.na(Smoke), Smoke, "Missing")) %>%
  plotCat("Smoke")

p_location <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mutate(Location = ifelse(!is.na(Location), Location, "Missing")) %>%
  plotCat("Location")

p_L4 <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mutate(L4 = ifelse(!is.na(L4), L4, "Missing")) %>%
  plotCat("L4")

p_behaviour <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mutate(Behaviour = ifelse(!is.na(Behaviour), Behaviour, "Missing")) %>%
  plotCat("Behaviour")

p_perianal <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mutate(Perianal = ifelse(!is.na(Perianal), Perianal, "Missing")) %>%
  plotCat("Perianal")

p_smoke
p_location
p_L4
p_behaviour
p_perianal
```


```{R}
myDF.fc %>% 
  filter(probmax_combined > 0.5) %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mlrPlot(var = c("sex"))
```

##### Ulcerative colitis

```{r}
p1 <- myDF.fc %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  plotCat("sex") +
  plot_annotation(title = "All subjects")

p2 <- myDF.fc %>%
  filter(probmax_combined > 0.5) %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  plotCat("sex") + 
  plot_annotation(title = "All subjects with prob > 0.5")

wrap_elements(p1) / wrap_elements(p2) + plot_layout(ncol = 2)
```

```{R}
myDF.fc %>% 
  filter(probmax_combined > 0.5) %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mlrPlot(var = "sex")
```

#### Age

As a reminder, age has been calculated by subtracting year of diagnosis from
year of birth and is therefore not 100% accurate. We will initially consider
age as a continuous variable. 

```{R}
aov(age ~ class_combined , data = myDF.fc) %>%
  summary() %>%
  pander()

aov(age ~ class_combined , data = myDF.fc[myDF.fc$probmax_combined > 0.5,]) %>%
  summary() %>%
  pander()
```


```{R}
#| label: fig-fc-age-dist
#| fig-cap: "Distribution of age at diagnosis by FC cluster assignment."
#| fig-height: 4
#| fig-width: 9.142857
#| warning: false
p1 <- myDF.fc %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p2 <- myDF.fc %>%
  subset(probmax_combined > 0.5) %>%
  ggplot(aes(x = class_combined, y = age)) +
  geom_violin(fill = "#5DB7DE", color = "#434371") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

print(p1)
```


##### All

```{R}
myDF.fc %>% 
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "age")
```

##### Crohn's disease

```{R}
myDF.fc %>% 
  filter(probmax_combined > 0.5) %>%
  filter(diagnosis == "Crohn's Disease") %>%
  mlrPlot(var = "age")
```


##### Ulcerative colitis

```{R}
myDF.fc %>% 
  filter(probmax_combined > 0.5) %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  mlrPlot(var = "age")
```

##### Montreal classification of age for Crohn's disease

Unlike ulcerative colitis, age at diagnosis is part of the Montreal
classification for Crohn's disease.  As such, we will explore potential
associations between Montreal age classification and cluster membership for
subjects diagnosed with Crohn's disease. The Montreal age categories are as
follows: 

* A1: $\leq$ 16 years
* A2: 17—40 years
* A3: $>$ 40 years

Montreal classification of age for Crohn's disease was not found to be
significantly associated with cluster membership.

```{R}
ageLabels <- c("\u226416", "17—40", "> 40")

myDF.fc.cd <- subset(myDF.fc, diagnosis == "Crohn's Disease")

myDF.fc.cd$ageCat <- cut(myDF.fc.cd$age,
  breaks = c(0, 16, 40, Inf),
  labels = ageLabels,
  include.lowest = TRUE,
  right = FALSE
)

myDF.fc.cd %>%
  filter(probmax_combined > 0.5) %>%
  with(fisher.test(class_combined,
                   ageCat,
                   workspace = 2000000,
                   simulate.p.value = TRUE)) %>%
  pander()
```

```{R}
myDF.fc.cd %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "ageCat")
```




### Multivariate modelling

For the multivariate analysis, multinomial logistic regression has been used to
predict class membership via age (as a continuous variable), sex, and IBD type.

Cluster FC 1, female sex, and Crohn's disease were used as the reference
categories. @tbl-mlr-fc provides all p-values for all covariates.

```{R}
#| label: tbl-mlr-fc
#| tbl-cap: "Table of p-values for the Wald tests of the multinomial logistic regression model."

myDF.fc %>%
  mutate(class_combined = relevel(class_combined, ref = "FC10 (n = 209)")) %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = c("age", "sex", "diagnosis", "baseline_fc"))
```

### Crohn's disease only data

This section is concerned with data specific to Crohn's disease, namely the
Montreal classification of Crohn's disease and advanced therapy prescribing. 

```{R}
cd.pheno <- readRDS(paste0(prefix, "processed/cd-pheno.RDS"))
cd.pheno <- merge(cd.pheno,
  myDF.fc[, c("ids", "class_combined", "probmax_combined")],
  by = "ids",
  all.x = FALSE,
  all.y = FALSE
)
```

#### Montreal location

Montreal location refers to where gastrointestinal inflammation is present and
is categorised as:

* L1: Ileal, limited to the ileum which is the final segment of the small
  intestine.
* L2: Colonic, limited to the colon/large intestine.
* L3: Ileocolonic, inflammation is present in both the ileum and colon.

A significant association was not found between cluster membership and Montreal
location. 


```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  with(chisq.test(class_combined, Location)) %>%
  pander()
```

```{R}
#| label: fig-fc-location-facet
#| fig-cap: "Percentage of (A) L1, (B) L2, and (C) L3 within each FC cluster. Dotted lines indicate the overall percentage of each IBD type."
p <- plotCat(cd.pheno, "Location")
ggsave("plots/cd-location-fc.png", p, width = 7.5, height = 7.5)
ggsave("plots/cd-location-fc.pdf", p, width = 7.5, height = 7.5)
print(p)
```

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "Location")
```

#### Upper GI inflammation

Upper inflammation refers to any gastrointestinal inflammation further up than
the ileum. Usually, upper inflammation is considered a _modifier_ for Montreal
location and is denoted L4. 

The presence of upper GI inflammation was found to be significantly associated
with cluster membership. 

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  with(fisher.test(class_combined, L4, workspace = 200000000)) %>%
  pander()
```

Cluster FC 2 appears to be enriched for CD subjects with L4 whilst a very low
percentage of CD subjects in FC 4 have L4.

```{R}
cd.pheno %>%
  drop_na(L4) %>%
  ggplot(aes(x = class_combined, fill = L4, color = L4)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("#F8766D", "#619CFF")) +
  scale_color_manual(values = c("#CF544B", "#417BD2")) +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cluster",
    y = "",
    fill = "L4 present",
    color = "L4 present"
  )
```


```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "L4")
```

#### Montreal behaviour

Montreal behaviour describes another clinical phenotype and is defined as
follows:

* B1: Inflammatory, in other words non-stricturing and non-penetrating
* B2: Stricturing, where the formation of fibrosis leads to the narrowing of the
  intestine.
* B3: Penetrating, where the inflammation causes the formation of fistulas or
  abscesses.

Montreal behaviour was found to be significantly associated with cluster
membership at the 5% significance level.

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  with(fisher.test(class_combined, Behaviour, simulate.p.value = TRUE)) %>%
  pander()
```

Whilst the inflammatory phenotype appears to be mostly evenly distributed across
the clusters, substantial differences are seen for stricturing disease and even
starker differences for penetrating. 

```{R}
#| label: fig-fc-behaviour-facet
#| fig-cap: "Percentage of (A) B1, (B) B2, and (C) B3 within each FC cluster. Dotted lines indicate the overall percentage of each IBD type."
p <- plotCat(cd.pheno, "Behaviour")
ggsave("plots/cd-behaviour-fc.png", p, width = 7.5, height = 7.5)
ggsave("plots/cd-behaviour-fc.pdf", p, width = 7.5, height = 7.5)
print(p)
```

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "Behaviour")
```

#### Perianal disease

Perianal disease is considered a modifier for Montreal behaviour and is a severe
complication of Crohn's disease involving inflammation around the anus.

Presence of perianal disease was not found to be significantly associated with
cluter membership for CD subjects. 

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  with(fisher.test(class_combined, Perianal, workspace = 20000000)) %>%
  pander()
```


```{R}
cd.pheno %>%
  drop_na(Perianal) %>%
  ggplot(aes(x = class_combined, fill = Perianal, color = Perianal)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("#F8766D", "#619CFF")) +
  scale_color_manual(values = c("#CF544B", "#417BD2")) +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cluster",
    y = "",
    fill = "Perianal disease present",
    color = "Perianal disease present"
  )
```

```{R}
cd.pheno %>%
  filter(probmax_combined > 0.5) %>%
  mlrPlot(var = "Perianal")
```

### Advanced therapy in CD

```{R}
dict.fc.cd <- readRDS(paste0(prefix, "processed/dict-fc-cd.RDS"))
dict.fc.cd <- merge(dict.fc.cd,
  myDF.fc[, c("ids", "class", "class_combined", "probmax_combined")],
  by = "ids",
  all.x = TRUE,
  all.y = FALSE
)
```

```{R}
pred.fc.df <- data.frame(
  calpro_time = c(seq(0, 7, 0.01), seq(0, 7, 0.01)),
  diagnosis = c(
    rep("Crohn's Disease", 701),
    rep("Ulcerative Colitis", 701)
  )
)
pred.fc.df.update <- predictY(model.fc, pred.fc.df,
  var.time = "calpro_time",
  draws = TRUE
)$pred

temp <- data.frame(Time = NULL, Cluster = NULL, Value = NULL)

for (g in 1:10) {
  temp <- rbind(
    temp,
    data.frame(
      Time = seq(0, 7, 0.01),
      Cluster = g,
      Value = pred.fc.df.update[, g]
    )
  )
}

dict.fc.cd$timeToTherapy <- with(dict.fc.cd, startDate - date.of.diag) / 365.25

for (g in 1:10) {
  p1 <- temp %>%
    filter(Cluster == g) %>%
    ggplot(aes(x = Time, y = Value)) +
    geom_line(color = "#558C8C") +
    theme_minimal() +
    ylim(3, 6.5) +
    xlab("") +
    ylab("Log (FCAL (\u03BCg/g))")
  p2 <- dict.fc.cd %>%
    filter(class == g) %>%
    filter(timeToTherapy > 0) %>%
    ggplot(aes(x = timeToTherapy)) +
    geom_density(color = "#5D002F", fill = "#82204A") +
    theme_minimal() +
    xlim(0, 7) +
    xlab("Time") +
    ylab("Density of time to first advanced therapy")
  p <- p1 / p2 + plot_annotation(
    title = paste("FC", g),
    subtitle = "Crohn's disease",
    tag_levels = "A"
  )
  ggsave(paste0("plots/at-density/g=", g, ".png"),
    p,
    width = 7,
    height = 7,
    units = "in",
    create.dir = TRUE
  )
  print(p)
}
```


```{R}
temp <- dict.fc.cd %>%
  mutate(timeToTherapy = if_else(advancedT == 1, 7, as.numeric(timeToTherapy))) %>%
  mutate(advancedT = if_else(advancedT == 1, 0, 1)) %>%
  mutate(advancedT = if_else(timeToTherapy > 7, 0, 1)) %>%
  mutate(timeToTherapy = if_else(timeToTherapy > 7, 7, timeToTherapy))

temp <- temp %>%
  mutate(timeToTherapy = if_else(timeToTherapy < 0, 0, timeToTherapy),
         advancedT = if_else(timeToTherapy == 7, 0, advancedT))


survfit(Surv(timeToTherapy, advancedT) ~ class, data = temp) %>%
  ggsurvplot(pval = TRUE, conf.int = FALSE)
```

```{R}
#| echo: false
png("plots/at-survival-fc-ci.png",
  width = 7,
  height = 5,
  units = "in",
  res = 300
)
survfit(Surv(timeToTherapy, advancedT) ~ class, data = temp) %>%
  ggsurvplot(pval = TRUE, conf.int = TRUE)
invisible(dev.off())
```


```{R}
p1 <- dict.fc.cd %>%
  ggplot() +
  geom_mosaic(aes(x = product(class), fill = firstY), show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "Cluster",
    y = "Advanced therapy within first year of diagnosis"
  ) +
  ggtitle(
    "Crohn's disease subjects",
    "Faecal calprotectin clustering"
  )
ggsave("plots/mosaic/fc-cd.png",
  p1,
  width = 7.5,
  height = 5,
  units = "in",
  dpi = 300,
  create.dir = TRUE
)
ggsave("plots/mosaic/fc-cd-AT.pdf", p, width = 7.5, height = 5)
p1
```

```{R}
pred.fc.df <- data.frame(
  calpro_time = c(seq(0, 7, 0.01), seq(0, 7, 0.01)),
  diagnosis = c(
    rep("Crohn's Disease", 701),
    rep("Ulcerative Colitis", 701)
  )
)
pred.fc.df.update <- predictY(model.fc, pred.fc.df,
  var.time = "calpro_time",
  draws = TRUE
)$pred

temp <- data.frame(Time = NULL, Cluster = NULL, Value = NULL)

for (g in 1:6) {
  temp <- rbind(
    temp,
    data.frame(
      Time = seq(0, 7, 0.01),
      Cluster = g,
      Value = pred.fc.df.update[, g]
    )
  )
}

traj.outlines <- list()

for (g in 1:6) {
  traj.outlines[[g]] <- temp %>%
    filter(Cluster == g) %>%
    ggplot(aes(x = Time, y = Value)) +
    geom_line(color = "#757575") +
    theme_classic() +
    theme(
      text = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_line(color = "#dfdfdf")
    ) +
    ylim(3, 6.5)
}



desc <- "Advanced therapy within first year of diagnosis for Crohn's disease"

p1 <- dict.fc.cd %>%
  ggplot(aes(x = class, fill = firstY, color = firstY)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("#F8766D", "#619CFF")) +
  scale_color_manual(values = c("#CF544B", "#417BD2")) +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cluster",
    y = "",
    fill = desc,
    color = desc
  )



p <- p1 /
  (traj.outlines[[1]] +
    traj.outlines[[2]] +
    traj.outlines[[3]] +
    traj.outlines[[4]] +
    traj.outlines[[5]] +
    traj.outlines[[6]] +
    plot_layout(ncol = 6, guides = "collect", widths = unit(3.9, "cm"))) +
  plot_layout(heights = c(4, 1))

ggsave("plots/mosaic/fc-by-AT-with-traj.pdf",
  p,
  width = 7 * 1.65,
  height = 5 * 1.65
)
ggsave("plots/mosaic/fc-by-AT-with-traj.png",
  p,
  width = 7 * 1.65,
  height = 5 * 1.65
)
```

```{R}
sum(dict.fc.cd$firstY)
prop.table(table(dict.fc.cd$class, dict.fc.cd$firstY), margin = 1)
```

```{R}
with(
  dict.fc.cd,
  fisher.test(table(class, firstY), workspace = 2000000)
)
```

### Demographics table

## CRP

```{R}
model.crp$pprob$class <- plyr::mapvalues(
  model.crp$pprob$class,
  from = c(8, 9),
  to = c(7, 8)
)
```

As Cluster CRP2 and CRP4 are characterised by very similar longitudinal
profiles, we have elected to merge these clusters. All subjects in cluster
4 have been migrated to cluster 2 with clusters 5-9 renumbered accordingly.

Similar to FC, we will explore associations only for subjects with a
sufficiently high posterior probability of being in their assigned cluster. As 
cluster assignment is exclusive, we are able to add the posterior probabilities
for the merged clusters together to determine the posterior probability for
CRP2 after the merge. 

### Sex

```{R}
dict.crp <- subset(dict, ids %in% model.crp$pprob$ids)
dict.crp <- merge(dict.crp, model.crp$pprob[, c("ids", "class")])


crp.median <-
  crp.median %>%
  select(-sex) %>%
  merge(dict.crp[, c("ids", "class", "sex")],
    all.x = TRUE,
    all.y = FALSE
  )

chisq.test(dict.crp$class, dict.crp$sex) %>%
  pander()
```

### Age

Age has been calculated by subtracting year of diagnosis from year of birth. 

```{R}
dict.crp$ageCat <- cut(dict.crp$age,
  breaks = c(0, 18, 30, 50, 70, Inf),
  labels = c("<18", "18-29", "30-49", "50-69", "\u226570"),
  include.lowest = TRUE,
  right = FALSE
)

crp.median <- merge(crp.median,
  dict.crp[, c("ids", "ageCat")],
  by = "ids",
  all.x = TRUE,
  all.y = FALSE
)

aov(class ~ age, data = dict.crp) %>%
  summary() %>%
  pander()
```


```{R}
#| label: fig-crp-age-dist
#| fig-cap: "Distribution of age at diagnosis by CRP cluster assignment."
#| fig-height: 4
#| fig-width: 9.142857
#| warning: false
p2 <- dict.crp %>%
  mutate(class = factor(class, labels = paste("CRP", seq(1, 8)))) %>%
  ggplot(aes(x = class, y = age)) +
  geom_violin(fill = "#D4CDF4", color = "#7A6F9B") +
  theme_minimal() +
  xlab("Cluster") +
  ylab("Age at diagnosis")

p <- p1 / p2 + plot_annotation(tag_levels = "A") &
  theme(plot.tag = element_text(size = 16, face = "bold"))

ggsave("plots/age-dist.png", p, width = 16 * 4 / 7, height = 8)
ggsave("plots/age-dist.pdf", p, width = 16 * 4 / 7, height = 8)
print(p2)
```


### IBD type

As with the FC  model, IBD type has been included in the cluster assignment sub
model as a covariate. Crohn's disease is the reference IBD type with cluster
CRP 8 being the reference cluster. 


```{R}
#| label: fig-crp-ibd
#| fig-cap: "Forest plot of IBD type for the chosen CRP model."
n.clust <- 8
id <- 1:length(model.crp$best)

indice <- rep(id * (id + 1) / 2)

se <- sqrt(model.crp$V[indice])
coefficient <- coef(model.crp)
var.names <- names(coefficient)

df <- data.frame(coefficient = coefficient, se = se)
df <- df[1:(3 * (n.clust - 1)), ]

df$lower <- df$coefficient - (qnorm(0.975) * df$se)
df$upper <- df$coefficient + (qnorm(0.975) * df$se)
df$labels <- names(coefficient)[1:(3 * (n.clust - 1))]

df$labels <- factor(df$labels, levels = rev(df$labels))

df$sig <- FALSE

df[df$upper < 0, "sig"] <- TRUE
df[df$lower > 0, "sig"] <- TRUE

df <- df[n.clust:(3 * (n.clust - 1)), ] # Remove intercept

df %>%
  ggplot(aes(
    x = labels,
    y = coefficient,
    ymin = lower,
    ymax = upper,
    color = sig
  )) +
  geom_errorbar() +
  geom_point(size = 3.5) +
  geom_hline(yintercept = 0, lty = 2) +
  coord_flip() + # flip coordinates (puts labels on y axis)
  xlab("") +
  ylab("Estimate (95% CI)") +
  theme_bw() +
  ylim(-4, 4) +
  scale_color_manual(values = c("black", "#FF007F")) +
  theme(legend.position = "none")
```

```{R}
#| label: tbl-crp-ibd
#| fig-cap: "Table of β estimates and associated p-values obtained via univariate Wald tests."
wald <- c()
p.vals <- c()

for (index in seq(n.clust, 3 * (n.clust - 1))) {
  temp <- WaldMult(model.crp, pos = index)
  wald <- c(wald, temp[, 1])
  p.vals <- c(p.vals, temp[, 2])
}

df$wald <- wald
df$p.vals <- p.vals

rownames(df) <- df$labels

df %>%
  select(coefficient, se, wald, p.vals) %>%
  knitr::kable(digits = 3, col.names = c("Estimate", "SE", "Wald", "p-value"))
```

```{R}
dict.crp$diagnosis <- factor(dict.crp$diagnosis,
  levels = c(
    "Crohn's Disease",
    "Ulcerative Colitis",
    "IBDU"
  )
)

dict.crp$class <- factor(dict.crp$class,
  levels = seq(1, 8),
  labels = paste0("CRP ", seq(1, 8))
)

p2 <- dict.crp %>%
  ggplot() +
  geom_mosaic(aes(x = product(class), fill = diagnosis), show.legend = FALSE) +
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) +
  theme_minimal() +
  labs(
    x = "Cluster",
    y = "IBD type"
  ) +
  ggtitle(
    "IBD type",
    "CRP clustering"
  )

ggsave("plots/mosaic/crp-by-diag.png",
  p2,
  width = 7.5,
  height = 5,
  units = "in",
  dpi = 300,
  create.dir = TRUE
)
ggsave("plots/mosaic/crp-by-diag.pdf", p2, width = 7.5, height = 5)

p6 <- dict.crp %>%
  ggplot(aes(x = class, fill = diagnosis, color = diagnosis)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("#F8766D", "#619CFF", "#00BA38")) +
  scale_color_manual(values = c("#CF544B", "#417BD2", "#01932A")) +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cluster",
    y = "",
    fill = "IBD type",
    color = "IBD type"
  )
p6
```

```{R}
#| label: fig-crp-ibd-facet
#| fig-cap: "Percentage of (A) Crohn's disease, (B) ulcerative colitis, and (C) IBDU within each CRP cluster. Dotted lines indicate the overall percentage of each IBD type."
perc.table <- data.frame(
  diagnosis = character(),
  cluster = character(),
  perc = numeric()
)
for (g in 1:8) {
  temp.1 <- subset(dict.crp, class == paste0("CRP ", g))
  for (diag in c("Crohn's Disease", "Ulcerative Colitis", "IBDU")) {
    perc <- nrow(subset(temp.1, diagnosis == diag)) / nrow(temp.1)
    perc.table <- rbind(
      perc.table,
      data.frame(
        diagnosis = diag,
        cluster = paste0("CRP ", g),
        perc = perc
      )
    )
  }
}

totalCdPerc <- nrow(subset(dict.crp, diagnosis == "Crohn's Disease")) /
  nrow(dict.crp)

p1 <- perc.table %>%
  filter(diagnosis == "Crohn's Disease") %>%
  ggplot(aes(x = cluster, y = perc)) +
  geom_bar(stat = "identity", fill = "#F8766D", color = "#CF544B") +
  geom_hline(yintercept = totalCdPerc, linetype = "dashed", color = "#4D4730") +
  theme_minimal() +
  labs(x = "Cluster", y = "Percentage")

totalCdPerc <- nrow(subset(dict.crp, diagnosis == "Ulcerative Colitis")) /
  nrow(dict.crp)

p2 <- perc.table %>%
  filter(diagnosis == "Ulcerative Colitis") %>%
  ggplot(aes(x = cluster, y = perc)) +
  geom_bar(stat = "identity", fill = "#619CFF", color = "#417BD2") +
  geom_hline(yintercept = totalCdPerc, linetype = "dashed", color = "#4D4730") +
  theme_minimal() +
  labs(x = "Cluster", y = "Percentage")


totalCdPerc <- nrow(subset(dict.crp, diagnosis == "IBDU")) /
  nrow(dict.crp)

p3 <- perc.table %>%
  filter(diagnosis == "IBDU") %>%
  ggplot(aes(x = cluster, y = perc)) +
  geom_bar(stat = "identity", fill = "#00BA38", color = "#01932A") +
  geom_hline(yintercept = totalCdPerc, linetype = "dashed", color = "#4D4730") +
  theme_minimal() +
  labs(x = "Cluster", y = "Percentage")

p <- p1 / p2 / p3 + patchwork::plot_annotation(tag_levels = "A")  &
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) 
ggsave("plots/ibd-type-crp.png", p, width = 7.5, height = 7.5)
ggsave("plots/ibd-type-crp.pdf", p, width = 7.5, height = 7.5)
print(p)
```

### Advanced therapy in CD

```{R}
dict.crp.cd <- readRDS(paste0(prefix, "processed/dict-crp-cd.RDS"))

dict.crp.cd <- merge(dict.crp.cd,
  dict.crp[, c("ids", "class")],
  by = "ids",
  all.x = TRUE,
  all.y = FALSE
)
```



```{R}
pred.crp.df <- data.frame(
  crp_time = c(seq(0, 6.25, 0.01), seq(0, 6.25, 0.01)),
  diagnosis = c(
    rep("Crohn's Disease", 626),
    rep("Ulcerative Colitis", 626)
  )
)
pred.crp.df.update <- predictY(model.crp, pred.crp.df,
  var.time = "crp_time",
  draws = TRUE
)$pred

temp <- data.frame(Time = NULL, Cluster = NULL, Value = NULL)

for (g in 1:8) {
  temp <- rbind(
    temp,
    data.frame(
      Time = seq(0, 6.25, 0.01),
      Cluster = g,
      Value = pred.crp.df.update[, g]
    )
  )
}


dict.crp.cd$timeToTherapy <- with(dict.crp.cd, startDate - date.of.diag) / 365.25

for (g in 1:8) {
  p1 <- temp %>%
    filter(Cluster == g) %>%
    ggplot(aes(x = Time, y = Value)) +
    geom_line(color = "#558C8C") +
    theme_minimal() +
    ylim(0, 6) +
    xlab("") +
    ylab("Log (CRP (\u03BCg/mL))")
  p2 <- dict.crp.cd %>%
    filter(class == paste0("CRP ", g)) %>%
    filter(timeToTherapy > 0) %>%
    ggplot(aes(x = timeToTherapy)) +
    geom_density(color = "#5D002F", fill = "#82204A") +
    theme_minimal() +
    xlim(0, 7) +
    ylim(0, NA) +
    xlab("Time") +
    ylab("Density of time to first advanced therapy")
  p <- p1 / p2 + plot_annotation(
    title = paste("CRP ", g),
    subtitle = "Crohn's disease",
    tag_levels = "A"
  )
  ggsave(paste0("plots/at-density-crp/g=", g, ".png"),
    p,
    width = 7,
    height = 7,
    units = "in",
    create.dir = TRUE
  )
  print(p)
}
```

```{R}
temp <- dict.crp.cd %>%
  mutate(timeToTherapy = if_else(advancedT == 1, 7, as.numeric(timeToTherapy))) %>%
  mutate(advancedT = if_else(advancedT == 1, 0, 1)) %>%
  mutate(advancedT = if_else(timeToTherapy > 7, 0, 1)) %>%
  mutate(timeToTherapy = if_else(timeToTherapy > 7, 7, timeToTherapy))
survfit(Surv(timeToTherapy, advancedT) ~ class, data = temp) %>%
  ggsurvplot(pval = TRUE)
```

```{R}
#| echo: false
png("plots/at-survival-crp-ci.png",
  width = 7,
  height = 5,
  units = "in",
  res = 300
)
survfit(Surv(timeToTherapy, advancedT) ~ class, data = temp) %>%
  ggsurvplot(pval = TRUE, conf.int = TRUE)
invisible(dev.off())
```


```{R}
p <- dict.crp.cd %>%
  ggplot() +
  geom_mosaic(aes(x = product(class), fill = firstY), show.legend = FALSE) +
  theme_minimal() +
  labs(
    x = "Cluster",
    y = "Advanced therapy within first year of diagnosis"
  ) +
  ggtitle(
    "Crohn's disease subjects",
    "CRP clustering"
  )
ggsave("plots/mosaic/crp-cd.png",
  p,
  width = 7.5,
  height = 5,
  units = "in",
  dpi = 300,
  create.dir = TRUE
)
ggsave("plots/mosaic/crp-cd.pdf", p, width = 7.5, height = 5)
p
```

```{R}
pred.crp.df <- data.frame(
  crp_time = c(seq(0, 7, 0.01), seq(0, 7, 0.01)),
  diagnosis = c(
    rep("Crohn's Disease", 701),
    rep("Ulcerative Colitis", 701)
  )
)
pred.crp.df.update <- predictY(model.crp, pred.crp.df,
  var.time = "crp_time",
  draws = TRUE
)$pred

temp <- data.frame(Time = NULL, Cluster = NULL, Value = NULL)

for (g in 1:8) {
  temp <- rbind(
    temp,
    data.frame(
      Time = seq(0, 7, 0.01),
      Cluster = g,
      Value = pred.crp.df.update[, g]
    )
  )
}

traj.crp.outlines <- list()

for (g in 1:8) {
  traj.crp.outlines[[g]] <- temp %>%
    filter(Cluster == g) %>%
    ggplot(aes(x = Time, y = Value)) +
    geom_line(color = "#757575") +
    theme_classic() +
    theme(
      text = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_line(color = "#dfdfdf")
    ) +
    ylim(0, 6)
}


p1 <- dict.crp.cd %>%
  ggplot(aes(x = class, fill = firstY, color = firstY)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("#F8766D", "#619CFF")) +
  scale_color_manual(values = c("#CF544B", "#417BD2")) +
  theme_minimal() +
  theme(legend.position = "top") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Cluster",
    y = "",
    fill = desc,
    color = desc
  )


p <- (p1) /
  (traj.crp.outlines[[1]] +
    traj.crp.outlines[[2]] +
    traj.crp.outlines[[3]] +
    traj.crp.outlines[[4]] +
    traj.crp.outlines[[5]] +
    traj.crp.outlines[[6]] +
    traj.crp.outlines[[7]] +
    traj.crp.outlines[[8]] +
    plot_layout(ncol = 8, guides = "collect", widths = unit(2.8, "cm"))) +
  plot_layout(heights = c(4, 1), nrow = 2)

ggsave("plots/mosaic/crp-by-AT-with-traj.pdf",
  p,
  width = 7 * 1.65,
  height = 5 * 1.65
)
ggsave("plots/mosaic/crp-by-AT-with-traj.png",
  p,
  width = 7 * 1.65,
  height = 5 * 1.65
)
```

### Mutlivariate modelling

```{R}
mlr <- multinom(class ~ age + sex + diagnosis, data = dict.crp, trace = FALSE)
z <- summary(mlr)$coefficients / summary(mlr)$standard.errors
p <- (1 - pnorm(abs(z), 0, 1)) * 2
knitr::kable(p)
```

### Demographics table

## Reuse {.appendix}

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.
 
## {.appendix}

<div class = "center">
  <img class = "center" src="../../images/MRC_HGU_Edinburgh RGB.png" alt="MRC Human Genetics Unit logo" height = 50px>
  <img src="../../images/cgem-logo.png" alt="Centre for Genomic & Experimental Medicine logo" height = 50px>
</div>

---

## Session info {.appendix}

```{R Session info}
pander(sessionInfo())
```


