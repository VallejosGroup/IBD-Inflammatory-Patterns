---
title: "Comparison of FC and CRP clustering"
author:
  - name: "Nathan Constantine-Cooke" 
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    corresponding: true
    affiliations:
      - ref: CGEM
      - ref: HGU
  - name: "Karla Monterrubio-Gómez"
    url: https://scholar.google.com/citations?user=YmyxSXAAAAAJ&hl=en
    affiliations:
      - ref: HGU
      - ref: CGEM
  - name: "Catalina A. Vallejos"
    url: https://scholar.google.com/citations?user=lkdrwm0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: HGU
      - ref: Turing
#comments:
#  giscus: 
#    repo: quarto-dev/quarto-docs
---

```{R}
suppressPackageStartupMessages(library(libdr))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(tidyverse))
library(ggalluvial)
library(lcmm)
library(patchwork)
library(gameR)
library(pander)
set.seed(123)
prefix <- "/Volumes/igmm/cvallejo-predicct/libdr/"

########################
### Load FC models ###
########################
# set the number of groups
G.fcal <- numeric()
models.fcal <- list()
G.cands <- seq(2, 10)
for (G.cand in G.cands) {
  file.name <- paste0(prefix, "cache/fcal/ncs/fcal-", G.cand, ".RDS")
  if (file.exists(file.name)) {
    G.fcal <- c(G.fcal, G.cand)
    models.fcal[[G.cand]] <- readRDS(file.name)
  }
}
rm(G.cand, G.cands)

dict <- readRDS(paste0(prefix, "processed/dict.RDS"))

####################################################################
### Load CRP moving average (no autocorrelation struture) models ###
####################################################################
G.crp <- numeric()
models.crp <- list()
G.cands <- seq(2, 10)
for (G.cand in G.cands) {
  file.name <- paste0(prefix, "cache/crp-ma/crp-", G.cand, ".RDS")
  if (file.exists(file.name)) {
    G.crp <- c(G.crp, G.cand)
    models.crp[[G.cand]] <- readRDS(file.name)
  }
}
rm(G.cand, G.cands)
```


```{R}
fcal.pprob <- models.fcal[[8]]$pprob
crp.pprob <- models.crp[[8]]$pprob

fcal.ids <- fcal.pprob$ids
crp.ids <- crp.pprob$ids

# Only IDs in both FCAL and CRP models
ids.comb <- fcal.ids[fcal.ids %in% crp.ids]
ids.comb <- ids.comb[order(ids.comb)]

fcal.pprob <- subset(fcal.pprob, ids %in% ids.comb)
crp.pprob <- subset(crp.pprob, ids %in% ids.comb)


classes <- rbind(data.frame(fcal.pprob[, c(1,2)], type = "FCAL" ),
                 data.frame(crp.pprob[, c(1,2)], type = "CRP"))
classes$class <- as.factor(classes$class)

p1 <- ggplot(classes, aes(x = type,
                          stratum = class,
                          alluvium = ids,
                          fill = class,
                          label = class)) +
  geom_flow()  +
  geom_stratum()  +
  geom_text(stat = "stratum", size = 3) +
  theme_minimal() +
  theme(axis.line = element_line(colour = "gray")) +
  theme(legend.position='bottom')


calpro_time <- seq(0, 7, by = 0.1)

new.data <- cbind(calpro_time, ns(calpro_time, df = 4, Boundary.knots = c(0,7)))
new.data <- rbind(data.frame(new.data, diagnosis = "Crohn's"),
                  data.frame(new.data, diagnosis = "UC"))


preds.fcal <- predictY(models.fcal[[6]], newdata = new.data, draws = TRUE)
plot.fcal <- data.frame(time = calpro_time,
                        pred = preds.fcal$pred[, "Ypred_class1"],
                        class = "1" )
for (class in as.character(2:6)){
  plot.fcal <- rbind(plot.fcal,
                     data.frame(time = calpro_time,
                                pred = preds.fcal$pred[, paste0("Ypred_class", class)],
                                class = class))
}

p2 <- ggplot(plot.fcal, aes(x = time, y = pred, color = class)) +
  geom_line(linewidth = 0.7) +
  theme_minimal() +
  xlab("Time (years)") +
  ylab("Log(FCAL (µg/g))") +
  ylim(0, 7) +
  xlim(0, 7) +
  theme(axis.line = element_line(colour = "gray"), legend.position = "none") 

crp_time <- seq(0,7, by = 0.1)

new.data <- cbind(crp_time, ns(crp_time, df = 4, Boundary.knots = c(0, 7)))
new.data <- rbind(data.frame(new.data, diagnosis = "Crohn's"),
                  data.frame(new.data, diagnosis = "UC"))

preds.crp <- predictY(models.crp[[8]], newdata = new.data, draws = TRUE)
plot.crp <- data.frame(time = crp_time,
                       pred = preds.crp$pred[, "Ypred_class1"],
                       class = "1" )
for (class in as.character(2:8)){
  plot.crp <- rbind(plot.crp,
                    data.frame(time = crp_time,
                               pred = preds.crp$pred[, paste0("Ypred_class",class)],
                               class = class))
}

p3 <- ggplot(plot.crp, aes(x = time, y = pred, color = class)) +
  geom_line(linewidth = 0.7) +
  theme_minimal() +
  xlab("Time (years)") +
  ylab("Log(CRP (mg/L))") +
  ylim(0,7) +
  xlim(0,7) +
  theme(axis.line = element_line(colour = "gray")) +  theme(legend.position='none')

p <- p1 + (p3/p2) +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = "collect")  &  theme(legend.position='bottom') & guides(fill = guide_legend(nrow = 1))

ggsave("plots/big-comp.png", p, width = 10, height = 6.75)
ggsave("plots/big-comp.pdf", p, width = 10, height = 6.75)
print(p)
```

```{R}
#| include: false
ids.shared <- intersect(models.fcal[[6]]$pprob$ids, models.crp[[8]]$pprob$ids)

fc.df <- subset(models.fcal[[6]]$pprob, ids %in% ids.shared)[,c(1, 2)]
colnames(fc.df) <- c("ids", "FCcluster")
crp.df <- subset(models.crp[[8]]$pprob, ids %in% ids.shared)[,c(1, 2)]
colnames(crp.df) <- c("ids", "CRPcluster")
mapping <- merge(fc.df, crp.df, by = "ids")

tab <- with(mapping, table(FCcluster, CRPcluster))
rowSums(tab)
colSums(tab)
```

Out of subjects paired in FC, how many are also paired in CRP?

```{R}
paired <- 0
doublePaired <- 0

for (i in fc.df$ids) {
  for (j in fc.df$ids) {
    if (i != j) {
      if (subset(fc.df, ids == i)$FCcluster == subset(fc.df, ids == j)$FCcluster){
        paired <- paired + 1
        if (subset(crp.df, ids == i)$CRPcluster == subset(crp.df, ids == j)$CRPcluster) {
          doublePaired <- doublePaired + 1
        }
      }
    }
  }
}

doublePaired / paired
```


Of out subjects paired in CRP, how many are also paired in FC?

```{R}
paired <- 0
doublePaired <- 0

for (i in crp.df$ids) {
  for (j in crp.df$ids) {
    if (i != j) {
      if (subset(crp.df, ids == i)$CRPcluster == subset(crp.df, ids == j)$CRPcluster){
        paired <- paired + 1
        if (subset(fc.df, ids == i)$FCcluster == subset(fc.df, ids == j)$FCcluster) {
          doublePaired <- doublePaired + 1
        }
      }
    }
  }
}

doublePaired / paired
```



## Reuse {.appendix}

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.
 
## {.appendix}

<div class = "center">
  <img class = "center" src="../../images/MRC_HGU_Edinburgh RGB.png" alt="MRC Human Genetics Unit logo" height = 50px>
  <img src="../../images/cgem-logo.png" alt="Centre for Genomic & Experimental Medicine logo" height = 50px>
</div>

---

## Session info {.appendix}

```{R Session info}
pander(sessionInfo())
```
